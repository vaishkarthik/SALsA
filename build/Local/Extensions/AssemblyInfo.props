<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <Target Name="SetLocalVersionInfo" 
          DependsOnTargets="GetLocalVersioninfo" 
          BeforeTargets="DetermineAssemblyVersionInfo"
          Condition="Exists('$(BuildVersionXml)')">

     <ItemGroup>
      <VersionSchemaCheck Include="$(Version4PartVersion.Split('.'))" />
     </ItemGroup>

     <PropertyGroup>
        <VersionMajor>$(Version4PartVersion.Split('.')[0])</VersionMajor>
        <VersionMinor>$(Version4PartVersion.Split('.')[1])</VersionMinor>
        <VersionBuildNumber>$(Version4PartVersion.Split('.')[2])</VersionBuildNumber>
        <VersionBuildRevision>$(Version4PartVersion.Split('.')[3])</VersionBuildRevision>
        <AssemblyInfoInformationalVersion>$(Version4PartVersion)$(VersionBuildLabel)</AssemblyInfoInformationalVersion>
        <AssemblyInfoAssemblyVersion>$(VersionMajor).$(VersionMinor).0.0</AssemblyInfoAssemblyVersion>
        <AssemblyInfoFileVersion>$(Version4PartVersion)</AssemblyInfoFileVersion>
        <VersionSchemaCheckCount>@(VersionSchemaCheck->Count())</VersionSchemaCheckCount>
     </PropertyGroup>
   
     <Message Text="VersionSchema does not align with Major.Minor.BuildNumber.Revision format. Assembly/Binary versioning might not be as expected"
              Importance="High"
              Condition="$(VersionSchemaCheckCount) &lt; 4" />

  </Target>

  <Target Name="GenerateNugetVersion"
          BeforeTargets="BeforeBuild"
          DependsOnTargets="SetLocalVersionInfo"
          Condition=" '$(MSBuildProjectExtension)' == '.nuproj'">

     <PropertyGroup>
       <Version Condition="'$(VersionBuildRevision)' == '0' ">$(VersionMajor).$(VersionMinor).$(VersionBuildNumber)</Version>
       <Version Condition="'$(VersionBuildRevision)' != '0' ">$(VersionMajor).$(VersionMinor).$(VersionBuildNumber).$(VersionBuildRevision)</Version>
       <Version Condition="'$(VersionTag)' != ''">$(Version)-$(VersionTag)</Version>
     </PropertyGroup>
  
  </Target>

  <Target Name="GetLocalVersionInfo"
          BeforeTargets="DetermineAssemblyVersionInfo"
          Condition="Exists('$(BuildVersionXml)')">
    <XmlPeek XmlInputPath="$(BuildVersionXml)"
      Query="/root/versions/version[@name='filever']/@value">
      <Output TaskParameter="Result" PropertyName="Version4PartVersion" />
    </XmlPeek>
  </Target>

</Project>